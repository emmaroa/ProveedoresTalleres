<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Captura de Cotizaci√≥n</title>
  <style>
    :root { --bg:#f8f6f2; --card:#fff; --text:#1f2937; --brand:#ff7f11; --accent:#10c6d1; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.08); }
    *{ box-sizing:border-box; } body{ margin:0; font-family: 'Segoe UI', Arial, sans-serif; color:var(--text); background:var(--bg); }
    header{ background:linear-gradient(135deg,var(--brand),var(--accent)); color:#fff; box-shadow:var(--shadow); }
    .hero{ max-width:1100px; margin:0 auto; padding:24px 16px; display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .hero img{ width:44px; }
    main{ display:grid; place-items:center; padding:26px 16px 36px; }
    .card{ width:100%; max-width:1100px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); }
    .card-head{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(16,198,209,.12); background:linear-gradient(180deg, rgba(16,198,209,.10), transparent); }
    form{ padding:18px; } label{ font-weight:700; margin-bottom:6px; display:block; }
    input, textarea{ width:100%; border:1px solid #ccc; border-radius:12px; padding:10px; }
    textarea{ resize:vertical; min-height:90px; }
    .form-row{ display:flex; gap:12px; flex-wrap:wrap; } .form-row .col{ flex:1; min-width:200px; }
    .table-wrap{ border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; }
    table{ width:100%; border-collapse:collapse; } thead th{ background:rgba(16,198,209,.1); padding:8px; }
    tbody td{ padding:6px; } tbody input{ width:100%; border:1px solid #ccc; border-radius:6px; padding:6px; }
    .actions{ display:flex; gap:8px; }
    .icon-btn{ border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:bold; }
    .icon-btn:hover{ background:#f0f0f0; }
    .btn {
      background:linear-gradient(135deg,var(--brand),var(--accent));
      color:#fff;
      border:none;
      border-radius:12px;
      padding:12px;
      font-weight:bold;
      cursor:pointer;
      margin-top:12px;
      width: 100%;
    }
    .btn:hover{
      filter:brightness(1.05);
      transform: scale(1.03);
    }
    #resultado{ margin-top:16px; text-align:center; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <img src="https://www.hermosillo.gob.mx/noticias/thumbnails/12749.gif" alt="Escudo de Hermosillo">
      <div>
        <h1>Captura de Cotizaci√≥n</h1>
        <p>‚ô•</p>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-head"><h2>Cotizaciones de Refacciones Entregadas en Almacen</h2></div>

      <form id="formCot">
        <div class="form-row">
          <div class="col">
            <label>Proveedor</label>
            <input type="text" id="proveedor" required>
          </div>
          <div class="col">
            <label>Unidad</label>
            <input type="text" id="unidad" required>
          </div>
        </div>

        <div class="form-row">
          <div class="col">
            <label>Fecha de entrega</label>
            <input type="date" id="fecha_entrega" required>
          </div>
        </div>

        <label>Notas</label>
        <textarea id="notas"></textarea>

        <div class="card-head" style="margin-top:12px;">
          <h2>Refacciones Entregadas</h2>
          <div class="actions">
            <button type="button" id="addRow" class="icon-btn">‚ûï Agregar</button>
            <button type="button" id="clearRows" class="icon-btn">üßπ Limpiar</button>
          </div>
        </div>

        <div class="table-wrap">
          <table id="tabla">
            <thead>
              <tr>
                <th>Cantidad</th>
                <th>Descripci√≥n / N¬∫ Parte</th>
                <th>Costo unitario SIN IVA</th>
                <th>Importe</th>
                <th></th>
              </tr>
            </thead>

            <!-- ‚úÖ tbody vac√≠o: JS crea 1 fila al iniciar -->
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <button type="submit" class="btn">Guardar</button>
        <div id="resultado"></div>
        <div id="folioMostrado" style="margin-top:10px; font-weight:700;"></div>
      </form>
    </section>
  </main>

  <script>
    const tbody = document.getElementById('tbody');

    // ‚úÖ Fecha local (evita desfase UTC)
    function hoyLocalISO() {
      const d = new Date();
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - tz).toISOString().slice(0, 10);
    }
    document.getElementById('fecha_entrega').value = hoyLocalISO();

    function nuevaFila() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" class="cant" min="0"></td>
        <td><input type="text" class="desc"></td>
        <td><input type="number" class="cost" step="0.01"></td>
        <td class="imp">$0.00</td>
        <td><button type="button" class="icon-btn del">‚úñ</button></td>`;
      tbody.appendChild(tr);
    }

    // ‚úÖ Arranque: 1 sola fila
    tbody.innerHTML = '';
    nuevaFila();

    // C√°lculo visual del importe por fila
    tbody.addEventListener('input', () => {
      tbody.querySelectorAll('tr').forEach(r => {
        const q = parseFloat(r.querySelector('.cant').value) || 0;
        const c = parseFloat(r.querySelector('.cost').value) || 0;
        r.querySelector('.imp').textContent = '$' + (q * c).toFixed(2);
      });
    });

    // Borrar fila (funciona aunque des click al emoji)
    tbody.addEventListener('click', e => {
      const btn = e.target.closest('.del');
      if (btn) btn.closest('tr').remove();
      if (tbody.querySelectorAll('tr').length === 0) nuevaFila();
    });

    document.getElementById('addRow').onclick = () => nuevaFila();
    document.getElementById('clearRows').onclick = () => {
      tbody.innerHTML = '';
      nuevaFila();
    };

    // ‚úÖ Pon aqu√≠ tu URL final /exec (recomendado), no /dev
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxs5GVfs0nUxfct-4ttfEZV4rHzlF6C3ALMVS3030mXeFE1OQuczcKWnL12-GK5BCct8A/exec';

    document.getElementById('formCot').addEventListener('submit', async (e) => {
      e.preventDefault();

      const filas = Array.from(document.querySelectorAll('#tbody tr')).map(r => ({
        cantidad: parseFloat(r.querySelector('.cant').value) || 0,
        descripcion: (r.querySelector('.desc').value || '').trim(),
        costo: parseFloat(r.querySelector('.cost').value) || 0
      })).filter(p => p.cantidad > 0 && p.descripcion !== '');

      const payload = {
        proveedor: (document.getElementById('proveedor').value || '').trim(),
        unidad: (document.getElementById('unidad').value || '').trim(),
        fecha_entrega: document.getElementById('fecha_entrega').value,
        notas: (document.getElementById('notas').value || '').trim(),
        partidas: filas
      };

      const div = document.getElementById('resultado');
      const folioDiv = document.getElementById('folioMostrado');
      div.textContent = 'Enviando‚Ä¶';
      folioDiv.textContent = '';

      try {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (json.ok) {
          folioDiv.textContent = `√öltimo folio: ${json.folio || ''}`;

          div.innerHTML = `
            ‚úÖ Guardado. Folio: <b>${json.folio || ''}</b><br><br>

            <a href="${json.pdfUrl}" target="_blank" rel="noopener"
              style="display:inline-block; padding:10px 12px; border-radius:10px; text-decoration:none; font-weight:700; border:1px solid #e5e7eb; margin-right:8px;">
              üìÑ Abrir PDF
            </a>

            <a href="${(json.downloadUrl || json.pdfUrl)}" target="_blank" rel="noopener"
              style="display:inline-block; padding:10px 12px; border-radius:10px; text-decoration:none; font-weight:700;
                      background:linear-gradient(135deg,var(--brand),var(--accent)); color:#fff;">
              ‚¨áÔ∏è Descargar PDF
            </a>
          `;

          // Opcional: limpiar formulario (deja fecha)
          // document.getElementById('formCot').reset();
          // document.getElementById('fecha_entrega').value = hoyLocalISO();
          // tbody.innerHTML = ''; nuevaFila();
        } else {
          div.textContent = '‚ùå Error: ' + (json.error || 'desconocido');
        }

      } catch (err) {
        div.textContent = '‚ùå Error de red: ' + err.message;
      }
    });
  </script>
</body>
</html>
